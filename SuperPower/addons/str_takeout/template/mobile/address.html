{template 'common/header'}
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=6E7C75E41980283b39d3c61e81f16a39"></script>
<link rel="stylesheet" type="text/css" href="../addons/str_takeout/template/resource/css/main.css">
<script src="../addons/str_takeout/template/resource/js/dialog.js"></script>
<script src="../addons/str_takeout/template/resource/js/intersectPolygon.js"></script>
<div id="allmap"></div>
{if $op == 'list'}
<style>
	body{background: #E5E5E5;}
	.cont_box, .menu_list li.cont_box{float: none;}
	.buyrecord{border-bottom-color: rgba(243,152,1,0);}
	.phone_number input{width: auto;font-size: 20px;max-width: 170px;}
</style>
<div class="cont_box">
	<div class="cont_box">
		<img class="cont_userimg" src="../addons/str_takeout/template/resource/images/penguin.png" />
		<!--src="../resource/images/penguin.png"-->

		<span class="cont_userdec">微信昵称</span>
		<br>
		<br>
		<span class="cont_userdec1">共{$total}个订单</span>
	</div>
</div>
{template 'header'}
<div class="cont_box">
	<div class="nav_wrapper">
		<div class="nav_inner">
			<a class="buyrecord" href="{php echo $this->createMobileUrl('myorder', array('sid' => $sid));}">购买记录</a>
			<a class="run_adress">地址管理</a>
		</div>
	</div>
	<hr width="102%" class="division" />
	<div class="cont_box">
		{if $stores}
		<div class="cont_box person_info">
			<img class="phone" src="../addons/str_takeout/template/resource/images/phone.png" />

			<br />
			
			<p class="phone_number" name="mobile" id="mobile" data-id="{$currentadd['id']}"><span>{$currentadd['mobile']}</span>
				<input class="hidden" type="text" name="mobile" id="mobileipt" value="{$currentadd['mobile']}" data-id="{$currentadd['id']}"  placeholder="手机" />
			</p>
			<img class="compiler" src="../addons/str_takeout/template/resource/images/edit.png" />
		</div>
		{/if}
	</div>
	<ul class="menu_list order_list cont_box">
		{if $stores}
			{loop $stores $store}
		<li style="margin: 0;margin-top: 15px;width: 100%;" class="cont_box">
			<span class="adress_name">
				{$store['title']}
			</span>
		</li>
				{php $addinstore=pdo_fetchall('SELECT * FROM ' . tablename('str_address').' WHERE sid='.$store['sid'].' AND '.tablename('str_address').'.uniacid = :aid AND '.tablename('str_address').'.uid = :uid', array(':aid' => $_W['uniacid'], ':uid' => $uid));}
				{loop $addinstore $address}
			<li style="padding: 0;width: 100%;margin: 0;" class="cont_box">
				<span class="adress_detailed addressChecked" data-id="{$address['id']}" data-sid="{$address['sid']}">{$address['address']}</span>
				<a class="adress_delete deladdress" data-id="{$address['id']}" data-sid="{$address['sid']}"></a>
			</li>
				{/loop}
			{/loop}
		{else}
		<li class="on-info"><i class="fa fa-info-circle"></i> 请添加地址</li>
		{/if}
		<div class="cont_box adress_add_wrapper"><a class="adress_add" href="{php echo $this->createMobileUrl('address', array('op' => 'post', 'sid' => $sid ,'r'=> $_GPC['r']))}" class="add">新增地址</a></div>
	</ul>
</div>
{elseif $op == 'post'||$op == 'init'}
<style>
	.home-position {
		margin-top: 30px;
		display:block;
		width: 100%;
		height:52px!important;
		line-height:52px;
		font-size:23px;
		background-color: #FFF;
		color: #F7B74D;
		border: 1px solid #F7B74D;
		border-radius: 3px;
	}
	.home-position:active,.home-position:hover,.home-position:visited{
		background-color: #FFF;
		color: #F7B74D;
		text-decoration: none;
	}
	.nav_sp_logo,.nav_sp_home{display:none;}
	.nav_sp{border: none;}
	input#location_input{
		text-align:center;
		width: 100%;
		height:52px!important;
		line-height:52px;
		font-size:23px;
		border: none;
		color: #FFF;
		background-color: #F7B74D;
		border-radius: 3px;
		padding: 0px 20px;
	}
	.line{
		margin: 10px 0;
	}
	.line input{
		line-height: 30px;
		height: 30px!important;
		font-size: 20px;
		text-align:center ;
	}
	@media (max-width: 720px) {
		input#location_input{
			font-size: 16px;
		}
		.home-position {
			margin-top: 10px;
			font-size: 16px;
		}
	}
	input#location_input::-webkit-input-placeholder { /* WebKit browsers */
	    color:    #FFF;
	}
	input#location_input:-moz-placeholder { /* Mozilla Firefox 4 to 18 */
	   color:    #FFF;
	   opacity:  1;
	}
	input#location_input::-moz-placeholder { /* Mozilla Firefox 19+ */
	   color:    #FFF;
	   opacity:  1;
	}
	input#location_input:-ms-input-placeholder { /* Internet Explorer 10+ */
	   color:    #FFF;
	}
</style>

<div class="cont_box">
	<div class="cont_box" style="text-align: center;"><img src="../addons/str_takeout/template/resource/images/logo.png" style="width: 60%;max-width: 367px;margin-top: 30px;"></div>
	<div style="position: relative;">
		<a name="#ddress"></a>
		<input type="text" name="address" id="location_input" style="padding:0;" autocomplete="off" placeholder="请输入您所在的楼宇" /><img id="search" style="position: absolute;height: 30px;display: block;top: 11px;right: 20px;" src="../addons/str_takeout/template/resource/images/search.png" /></div>
	<div style="position: relative;text-align: center;"><a class="home-position">定位到我所在的楼宇</a><img style="position: absolute;height: 30px;display: block;top: 11px;right: 20px;" src="../addons/str_takeout/template/resource/images/position.png" /></div>
	<div class="hidden">
		<input type="text" name="realname" value="{$address['realname']}" placeholder="姓名">
	</div>
	<div class="hidden">
		<input type="text" name="mobile" id="mobile" value="{$address['mobile']}" placeholder="手机">
	</div>
	<div class="address addr1 hidden">
		<input name="room" value="{$address['room']}" type="text" placeholder="楼层房号">
	</div>
</div>
{template 'header'}
<footer class="shopping_cart">
	<div class="fixed hidden" id="fix_bar">
		<div>
			<a id="submit" class="comm_btn">添加地址</a>
		</div>
	</div>
</footer>
{/if}
<script type="text/javascript">
	var user_iploc={php $url='http://api.map.baidu.com/location/ip?ak=6E7C75E41980283b39d3c61e81f16a39&ip='.'120.35.71.61'/*$_SERVER["REMOTE_ADDR"]*/;  $html = file_get_contents($url);  echo $html;} ;
	var user_loc="";
	var user_point=null;
	var ha_detail=null;
	var user_detail=null;
	{php $max=0;}
	{loop $otherArea $one}
		{php $max=intval($one['id'])>$max?intval($one['id']):$max;}
	{/loop}
	var storePoints=new Array({$max});
	var storeNames=new Array({$max});
	var storeCount={$max};
	var sid=-1;
	$(function(){
		var r = "{$_GPC['r']}";
		var return_url1 = "{php echo $this->createMobileUrl('order', array('op' => 'get','sid' => $sid, 'r' => 1));}";
		var return_url2 = "{php echo $this->createMobileUrl('dish');}";
		return_url1 = (return_url1.split('#'))[0];
		return_url2 = (return_url2.split('#'))[0];
		var map = new BMap.Map("allmap");
		var myGeo = new BMap.Geocoder();
		map.centerAndZoom(user_iploc.content.address,12);
		{if $op == 'post'|| $op == 'init'}
		var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
			{"input" : "location_input"
			,"location" : map
		});
		ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
			var _value = e.item.value;
			user_loc = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
			user_detail = _value;
			user_point = _value.point;
			$("#location_input").value = user_loc;
			$("#location_input").change();
		});
		if(0){
			$("#location_input").focus(function (){
				$(this).css("position","fixed").css("top","0").css("left","0").css("z-index","1000");
				$("#search").addClass("hidden");
				$(this).change();
			}).blur(function (){
				$("#search").removeClass("hidden");
				$(this).css("position","static");
				$(this).change();
			});
		}
		$("#location_input").change(function() {
			user_loc = this.value;
			myGeo.getPoint(user_loc, function(point){
				user_point=point;
				checkPointAvail();
			}, user_iploc.content.address);
		});
		$(".home-position").click(function(){
			if($(this).hasClass("hdisabled")){return false;}
			var geolocation = new BMap.Geolocation();
			geolocation.getCurrentPosition(function(r){
				user_detail=r;
				if((!!r.accuracy)&&r.accuracy<=200){
					ha_detail=r;
				}
				if((!!user_point)&&map.getDistance(user_point,r.point)<=(r.accuracy)&&(user_loc)){
					$("#location_input").val(user_loc);
				}else{
					var addr=r.address;
					$("#location_input").val(addr.province+addr.city+addr.street);
				}
				$("#location_input").change();
				user_point=r.point;
				checkPointAvail();
			},{enableHighAccuracy: true});

		});
		
		function checkPointAvail(){
			if(user_point){
				if(ha_detail&&ha_detail.accuracy){
					var dis=map.getDistance(user_point,ha_detail.point);
					if(dis<2*ha_detail.accuracy){
						user_point=ha_detail.point;
					}else{
						ha_detail=null;
					}
				}
				//显示输入框
				showInput();
				sid=-1;
				checkStore();
			}else{
				sid=-1;
				hideInput();
				//隐藏输入框
				if(ha_detail&&ha_detail.accuracy){
					user_point=ha_detail.point;
					checkPointAvail();
				}
			}
		}
		function showInput(){
			$("#fix_bar").removeClass("hidden");
			$(".line").removeClass("hidden");
			
		}
		function hideInput(){
			$(".line").addClass("hidden");
			$("#fix_bar").addClass("hidden");
		}
		function checkStore(){
			var storePoint="";
			{loop $otherArea $one}
			storePoint= '{$one['points']}';
			storePoints[{$one['id']}]  = eval(storePoint.replace(/&quot;/g,"\""));
			storeNames[{$one['id']}] = '{$one['title']}';
			{/loop}
			for(var i=0;i<storeCount;++i) {
				console.log("checking"+i);
				if((storePoints[i])&&(isIn(storePoints[i],{x:user_point.lng,y:user_point.lat}))){
					sid=i;
					break;
				}
			}
			if(sid>=0){
				$(".home-position").text("定位成功，门店"+storeNames[sid]+"将为您服务");
			}else{
				$(".home-position").text("很抱歉，您暂时不在我们的配送范围");
				hideInput();
			}
			if(!$(this).hasClass("hdisabled")){
				$(".home-position").addClass("hdisabled");
				setTimeout(function (){$(".home-position").text("定位到我所在的楼宇").removeClass("hdisabled");},10000);
			}
		}
		function isIn(storePoints,point){
		    var p1 = [];
		    for(var i = 0; i < storePoints.length; i++){
		        p1.push({x:storePoints[i].lng,y:storePoints[i].lat});
		    }
		    if(containsPointByLinearRing(point,p1)){
		        return true;
		    }else{
		        return false;
		    }
	 	}
		{/if}
		$('.addressChecked').click(function(){
			var address_id = $(this).attr('data-id');
			var address_sid = $(this).attr('data-sid');
			if(address_id) {
				$.post("{php echo $this->createMobileUrl('address', array('op' => 'default', 'sid' => $sid))}", {'id':address_id},function(){
					if(r==1) {
						location.href=return_url1 + '&address_id='+address_id;
					} else if(r==2) {
						location.href=return_url2 + '&address_id='+address_id+'&sid='+address_sid;
					} else if(r==3) {
						return false;
					} else {
						location.href = "{php echo $this->createMobileUrl('address', array('op' => 'list', 'sid' => $sid));}";
					}
				});
			}
			return false;
		});
		$(".compiler").click(function(){
			if($("#mobileipt").hasClass("hidden")){
				$("#mobileipt").removeClass("hidden");
				$("#mobile span").addClass("hidden");
			}
		});
		$("#mobileipt").blur(function(){
			var id = $(this).attr('data-id');
			if($("#mobile span").hasClass("hidden")){
				$("#mobileipt").addClass("hidden");
				$("#mobile span").removeClass("hidden");
			}
			var newmobile=$("#mobileipt").val();
			var valid = !!newmobile.match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/);
			if(!valid){
				$("#mobileipt").val($("#mobile span").html());
				alert('手机号格式不正确');
			}else{
				$("#mobile span").html(newmobile);
				$.post("{php echo $this->createMobileUrl('address', array('op' => 'post', 'sid' => $sid))}", {'id':id,'mobile': newmobile, 'address':'{$currentadd['address']}', 'room':'{$currentadd['room']}' , 'realname':'{$currentadd['realname']}'}, function(data){});
			}
		});
		$('#submit').click(function(){
			
			var id = '{$id}';
			var room = $.trim($(':text[name="room"]').val());
			var realname = $.trim($(':text[name="realname"]').val());
			var mobile = $.trim($(':text[name="mobile"]').val());
/*			var realname = $.trim($(':text[name="realname"]').val());
			if(!realname) {
				alert('预定人不能为空');
				return false;
			}
			var mobile = $.trim($(':text[name="mobile"]').val());
			if(!mobile) {
				alert('手机号不能为空');
				return false;
			}else{
				var valid = !!mobile.match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/);
				if(!valid){
					alert('手机号格式不正确');
					return false;
				}
			}*/
			var address = $.trim($(':text[name="address"]').val());
			if(!address) {
				alert('收件地址不能为空');
				return false;
			}
			/*var room = $.trim($(':text[name="room"]').val());
			if(!room) {
				alert('楼层房号不能为空');
				return false;
			}*/
			if(!$(this).hasClass('disabled')){
				$(this).addClass('disabled');	
				$.post("{php echo $this->createMobileUrl('address', array('op' => 'post', 'sid' => $sid))}", {'id':id,'address':address, 'room':room , 'mobile':mobile, 'realname':realname,'sid':sid}, function(data){
					var data = $.parseJSON(data);
					if(!data.errorno) {
						$.post("{php echo $this->createMobileUrl('address', array('op' => 'default', 'sid' => $sid))}", {'id':data.message},function(){
							if(r==1) {
								location.href=return_url1 + '&address_id='+data.message;
							} else if(r==2) {
								location.href=return_url2 + '&address_id='+data.message;
							} else {
								location.href = "{php echo $this->createMobileUrl('address', array('op' => 'list', 'sid' => $sid));}"
							}
						});
					} else {
						alert(data.message);
						$(this).removeClass('disabled');	
						return false;
					}
				});
			}
		});

		$('.deladdress').click(function(){
			var id = $(this).attr('data-id');
			if(!id) {
				return false;
			}
			if(!confirm('确定删除吗')) return false;
			$.post("{php echo $this->createMobileUrl('address', array('op' => 'del', 'sid' => $sid))}", {'id':id}, function(data){
				var data = $.parseJSON(data);
				if(!data.errorno) {
					location.href = "{php echo $this->createMobileUrl('address', array('op' => 'list', 'sid' => $sid, 'success' => 1, 'r' => $_GPC['r']));}";
				} else {
					alert(data.message);
					return false;
				}
			});
		});
		$('#deladdress').click(function(){
			var id = '{$id}';
			if(!id) {
				return false;
			}
			if(!confirm('确定删除吗')) return false;
			$.post("{php echo $this->createMobileUrl('address', array('op' => 'del', 'sid' => $sid))}", {'id':id}, function(data){
				var data = $.parseJSON(data);
				if(!data.errorno) {
					location.href = "{php echo $this->createMobileUrl('address', array('op' => 'list', 'sid' => $sid, 'r' => $_GPC['r']));}";
				} else {
					alert(data.message);
					return false;
				}
			});
		});
	});
</script>
{template 'common/footer'}